<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“Š Crypto Dashboard â€“ Top 20</title>
  <style>
    body{font-family:tahoma,Arial,sans-serif;direction:rtl;background:#f5f7fb;margin:0}
    header{background:#1e88e5;color:#fff;padding:14px 10px;text-align:center}
    .wrap{max-width:1600px;margin:16px auto;padding:0 12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input,select,button{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px;font-family:inherit}
    button{background:#1e88e5;color:#fff;cursor:pointer}
    button:disabled{background:#90caf9;cursor:not-allowed}
    .note{font-size:12px;color:#546e7a;margin-top:6px}
    .table-wrap{overflow:auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    table{border-collapse:collapse;width:100%;table-layout:auto}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:center;white-space:nowrap;font-size:13px}
    th{background:#e3f2fd;color:#0d47a1;position:sticky;top:0;z-index:2}
    tr:nth-child(even){background:#fafbff}
    tr:hover{background:#f1f7ff}
    th.sticky-col, td.sticky-col{position:sticky;left:0;background:#e3f2fd;z-index:3}
    td.sticky-col{background:#fff;z-index:1}
    th.sticky-col2, td.sticky-col2{position:sticky;left:60px;background:#e3f2fd;z-index:3}
    td.sticky-col2{background:#fff;z-index:1}
    .positive{color:#2e7d32;font-weight:600}
    .negative{color:#c62828;font-weight:600}
    .badge{padding:2px 6px;border-radius:8px;font-weight:600}
    .good{background:#e8f5e9;color:#2e7d32}
    .bad{background:#ffebee;color:#c62828}
    .neutral{background:#eceff1;color:#37474f}
    .muted{color:#607d8b}
    .nowrap{white-space:nowrap}
    .rsi-high{color:#c62828;font-weight:600}
    .rsi-low{color:#1565c0;font-weight:600}
    .tooltip{cursor:help;border-bottom:1px dashed #90a4ae}
  </style>
</head>
<body>
  <header>
    <h2>ğŸ“Š Û²Û° Ú©ÙˆÛŒÙ† Ø¨Ø±ØªØ± Ø¨Ø§Ø²Ø§Ø± â€“ Crypto Dashboard</h2>
    <div style="font-size:12px;opacity:.9">Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡: Binance (OHLCV) Ø§Ø² Ø·Ø±ÛŒÙ‚ Codetabs Proxy | Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</div>
  </header>

  <div class="wrap">
    <div class="controls">
      <label>ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…:</label>
      <select id="interval">
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
      <label>ÙÛŒÙ„ØªØ±:</label>
      <select id="filter">
        <option value="all">All</option>
        <option value="long">Long</option>
        <option value="short">Short</option>
        <option value="breakout">Breakout</option>
      </select>
      <input type="text" id="search" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Symbol">
      <button id="refreshBtn">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <span id="lastUpdate" class="note"></span>
    </div>

    <div class="table-wrap">
      <table id="crypto-table">
        <thead>
          <tr>
            <th class="sticky-col tooltip" title="Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ">Symbol</th>
            <th class="sticky-col2 tooltip" title="Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ">Price</th>
            <th class="tooltip" title="Relative Strength Index (14)">RSI(14)</th>
            <th class="tooltip" title="Exponential Moving Average (9)">EMA9</th>
            <th class="tooltip" title="EMA (20)">EMA20</th>
            <th class="tooltip" title="EMA (50)">EMA50</th>
            <th class="tooltip" title="EMA (100)">EMA100</th>
            <th class="tooltip" title="MACD Line">MACD</th>
            <th class="tooltip" title="Signal Line">Signal</th>
            <th class="tooltip" title="Ø´Ø±Ø· Long (Ø­Ø±ÙˆÙ)">L</th>
            <th class="tooltip" title="Ø´Ø±Ø· Short (Ø­Ø±ÙˆÙ)">S</th>
            <th class="tooltip" title="Pivot Point Ø±ÙˆØ²Ø§Ù†Ù‡">PP</th>
            <th class="tooltip" title="Ø³ÛŒÚ¯Ù†Ø§Ù„ Long (Ù†Ù‡Ø§ÛŒÛŒ)">Long</th>
            <th class="tooltip" title="Ø³ÛŒÚ¯Ù†Ø§Ù„ Short (Ù†Ù‡Ø§ÛŒÛŒ)">Short</th>
            <th class="tooltip" title="ÙˆØ±ÙˆØ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ">Entry</th>
            <th class="tooltip" title="Ø®Ø±ÙˆØ¬ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (TP/SL)">Exit</th>
            <th class="tooltip" title="Ø­Ù…Ø§ÛŒØª Ù…Ø­Ù„ÛŒ (20 Ú©Ù†Ø¯Ù„)">Support</th>
            <th class="tooltip" title="Ù…Ù‚Ø§ÙˆÙ…Øª Ù…Ø­Ù„ÛŒ (20 Ú©Ù†Ø¯Ù„)">Resistance</th>
            <th class="tooltip" title="ØªØ«Ø¨ÛŒØª Ø±ÙˆÛŒ Ø­Ù…Ø§ÛŒØª">Ø­Ù…Ø§ÛŒØªØŸ</th>
            <th class="tooltip" title="ØªØ«Ø¨ÛŒØª Ø±ÙˆÛŒ Ù…Ù‚Ø§ÙˆÙ…Øª">Ù…Ù‚Ø§ÙˆÙ…ØªØŸ</th>
            <th class="tooltip" title="Ø´Ú©Ø³Øª Ù…Ù‚Ø§ÙˆÙ…Øª Ø§Ø®ÛŒØ±">Breakout</th>
            <th class="tooltip" title="Ø¨Ø±Ú¯Ø´Øª Ø§Ø² Ø­Ù…Ø§ÛŒØª">Bounce</th>
            <th class="tooltip" title="EMA50 Ø¨Ø§Ù„Ø§ÛŒ EMA200">Golden Cross</th>
            <th class="tooltip" title="Ø±ÙˆÙ†Ø¯ ØµØ¹ÙˆØ¯ÛŒ Ù‚ÙˆÛŒ">Rally</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note">
      âš ï¸ Ù†Ú©ØªÙ‡: Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± ØµØ±ÙØ§Ù‹ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø§Ø³Øª Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù‚Ø·Ø¹ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø­Ø³ÙˆØ¨ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    </div>
  </div>

<script>
// ===== Config =====
const SYMBOLS = [
  "BTCUSDT","ETHUSDT","BNBUSDT","XRPUSDT","SOLUSDT",
  "ADAUSDT","DOGEUSDT","TRXUSDT","MATICUSDT","DOTUSDT",
  "LTCUSDT","AVAXUSDT","LINKUSDT","ATOMUSDT","ETCUSDT",
  "XLMUSDT","FILUSDT","APTUSDT","NEARUSDT","ICPUSDT"
];
const PROXY = (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
const fmt = (n,d=2) => (n==null||isNaN(n))?"-":Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
const withinPct = (price,level,pct=0.3)=>{if(!price||!level)return false;return Math.abs((price-level)/level)*100<=pct};

// ===== Fetch =====
async function fetchKlines(symbol,interval="15m",limit=300){
  const url=PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
  const res=await fetch(url);if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data=await res.json();if(!Array.isArray(data)) throw new Error("Bad payload");
  return data;
}
async function fetchDailyPivot(symbol){
  const url=PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=3`);
  const res=await fetch(url);if(!res.ok) return null;
  const data=await res.json();if(!Array.isArray(data)||data.length<2) return null;
  const prev=data[data.length-2];const H=+prev[2],L=+prev[3],C=+prev[4];return (H+L+C)/3;
}

// ===== Indicators =====
function ema(values,period){const k=2/(period+1);const out=[];let prev=values[0];out.push(prev);for(let i=1;i<values.length;i++){const v=values[i]*k+prev*(1-k);out.push(v);prev=v}return out}
function rsi(values,period=14){if(values.length<period+1)return[];let gains=0,losses=0;for(let i=1;i<=period;i++){const diff=values[i]-values[i-1];if(diff>=0)gains+=diff;else losses-=diff;}let avgGain=gains/period,avgLoss=losses/period;const out=new Array(period).fill(null);for(let i=period+1;i<values.length;i++){const diff=values[i]-values[i-1];const gain=diff>0?diff:0;const loss=diff<0?-diff:0;avgGain=(avgGain*(period-1)+gain)/period;avgLoss=(avgLoss*(period-1)+loss)/period;const rs=avgLoss===0?1000:avgGain/avgLoss;out.push(100-(100/(1+rs)))}return out}
function macd(values,fast=12,slow=26,signalPeriod=9){const ef=ema(values,fast);const es=ema(values,slow);const macdLine=ef.map((v,i)=>(es[i]==null?null:(v-es[i])));const start=slow;const macdValid=macdLine.slice(start).filter(v=>v!=null);const signalPart=ema(macdValid,signalPeriod);const signalLine=new Array(start).fill(null).concat(signalPart);return{macdLine,signalLine}}
function atr(highs,lows,closes,period=14){const trs=[];for(let i=0;i<highs.length;i++){if(i===0){trs.push(highs[i]-lows[i]);continue;}const hl=highs[i]-lows[i];const hc=Math.abs(highs[i]-closes[i-1]);const lc=Math.abs(lows[i]-closes[i-1]);trs.push(Math.max(hl,hc,lc));}if(trs.length<period)return[];let rma=trs.slice(0,period).reduce((a,b)=>a+b,0)/period;const out=new Array(period-1).fill(null);out.push(rma);for(let i=period;i<trs.length;i++){rma=(rma*(period-1)+trs[i])/period;out.push(rma)}return out}

// ===== Build Table =====
async function buildTable(){
  const tbody=document.querySelector("#crypto-table tbody");
  tbody.innerHTML="";
  const interval=document.getElementById("interval").value;

  for(const symbol of SYMBOLS){
    try{
      const [kl,pp]=await Promise.all([fetchKlines(symbol,interval,300),fetchDailyPivot(symbol)]);
      const closes=kl.map(k=>+k[4]),highs=kl.map(k=>+k[2]),lows=kl.map(k=>+k[3]),vols=kl.map(k=>+k[5]);
      const last=closes.at(-1),lastVol=vols.at(-1);
      const ema9Arr=ema(closes,9),ema20Arr=ema(closes,20),ema50Arr=ema(closes,50),ema100Arr=ema(closes,100),ema200Arr=ema(closes,200);
      const rsiArr=rsi(closes,14);const {macdLine,signalLine}=macd(closes,12,26,9);const atrArr=atr(highs,lows,closes,14);

      const ema9v=ema9Arr.at(-1),ema20v=ema20Arr.at(-1),ema50v=ema50Arr.at(-1),ema100v=ema100Arr.at(-1),ema200v=ema200Arr.at(-1);
      const rsiv=rsiArr.at(-1),macdv=macdLine.at(-1),sigv=signalLine.at(-1),atrv=atrArr.at(-1);

      const longCond=last>ema20v&&macdv!=null&&sigv!=null&&macdv>sigv&&rsiv>50;
      const shortCond=last<ema20v&&macdv!=null&&sigv!=null&&macdv<sigv&&rsiv<50;

      const L=longCond?"L":"",S=shortCond?"S":"",PP=pp?fmt(pp,2):"-";

      let entry="-",exitPlan="-";
      if(longCond&&atrv){entry=last.toFixed(4);exitPlan=`TP:${(last+1.5*atrv).toFixed(4)} | SL:${(last-1.0*atrv).toFixed(4)}`}
      else if(shortCond&&atrv){entry=last.toFixed(4);exitPlan=`TP:${(last-1.5*atrv).toFixed(4)} | SL:${(last+1.0*atrv).toFixed(4)}`}

      const last20=closes.slice(-20),support=Math.min(...last20),resistance=Math.max(...last20);
      const onSupport=withinPct(last,support,0.3)?"âœ…":"â€”",onResistance=withinPct(last,resistance,0.3)?"âœ…":"â€”";
      const breakout=last>resistance*1.002?"âœ…":"â€”";const prevRsi=rsiArr.slice(-2)[0];
      const bounce=withinPct(last,support,0.3)&&prevRsi!=null&&rsiv>prevRsi?"âœ…":"â€”";
      const ema50Prev=ema50Arr.at(-2),ema200Prev=ema200Arr.at(-2);
      const golden=(ema50Prev!=null&&ema200Prev!=null&&ema50Prev<ema200Prev&&ema50v>ema200v)?"âœ…":"â€”";
      const rally=(last>ema9v&&last>ema20v&&rsiv>70&&macdv>sigv)?"âœ…":"â€”";

      const macdClass=(macdv!=null&&sigv!=null&&(macdv-sigv)>=0)?"positive":"negative";
      const longBadge=longCond?'<span class="badge good">âœ…</span>':'<span class="badge neutral">â€”</span>';
      const shortBadge=shortCond?'<span class="badge bad">âš </span>':'<span class="badge neutral">â€”</span>';
      const rsiClass=rsiv>=70?"rsi-high":(rsiv<=30?"rsi-low":"");

      const tr=document.createElement("tr");
      tr.setAttribute("data-long",longCond);
      tr.setAttribute("data-short",shortCond);
      tr.setAttribute("data-breakout",breakout==="âœ…");

      tr.innerHTML=`
        <td class="sticky-col nowrap">${symbol}</td>
        <td class="sticky-col2">${fmt(last,4)}</td>
        <td class="${rsiClass}">${fmt(rsiv,2)}</td>
        <td>${fmt(ema9v,4)}</td>
        <td>${fmt(ema20v,4)}</td>
        <td>${fmt(ema50v,4)}</td>
        <td>${fmt(ema100v,4)}</td>
        <td class="${macdClass}">${fmt(macdv,6)}</td>
        <td class="${macdClass}">${fmt(sigv,6)}</td>
        <td>${L}</td>
        <td>${S}</td>
        <td>${PP}</td>
        <td>${longBadge}</td>
        <td>${shortBadge}</td>
        <td>${entry}</td>
        <td>${exitPlan}</td>
        <td>${fmt(support,4)}</td>
        <td>${fmt(resistance,4)}</td>
        <td>${onSupport}</td>
        <td>${onResistance}</td>
        <td>${breakout}</td>
        <td>${bounce}</td>
        <td>${golden}</td>
        <td>${rally}</td>`;
      tbody.appendChild(tr);
    }catch(err){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="24" class="negative">Ø®Ø·Ø§ Ø¨Ø±Ø§ÛŒ ${symbol}: ${err.message}</td>`;
      tbody.appendChild(tr);
    }
  }
  document.getElementById("lastUpdate").textContent="Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: "+new Date().toLocaleString();
  applyFilter();
}
function applyFilter(){
  const filter=document.getElementById("filter").value;
  const search=document.getElementById("search").value.toUpperCase();
  document.querySelectorAll("#crypto-table tbody tr").forEach(tr=>{
    const sym=tr.querySelector("td").innerText;
    let show=true;
    if(search&& !sym.includes(search)) show=false;
    if(filter==="long"&&tr.getAttribute("data-long")!=="true") show=false;
    if(filter==="short"&&tr.getAttribute("data-short")!=="true") show=false;
    if(filter==="breakout"&&tr.getAttribute("data-breakout")!=="true") show=false;
    tr.style.display=show?"":"none";
  });
}
document.getElementById("filter").addEventListener

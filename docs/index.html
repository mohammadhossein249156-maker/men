<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>üìä Crypto Dashboard</title>
  <style>
    body { font-family: Tahoma, sans-serif; direction: rtl; background:#f7f7f7; padding:20px; }
    table { border-collapse: collapse; width: 100%; background:#fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size:14px; }
    th { background: #333; color: #fff; }
  </style>
</head>
<body>
  <h1>üìä Crypto Dashboard</h1>
  <label>‚è± ÿßŸÜÿ™ÿÆÿßÿ® ÿ™ÿß€åŸÖ‚ÄåŸÅÿ±€åŸÖ:
    <select id="interval">
      <option value="15m">15m</option>
      <option value="1h">1h</option>
      <option value="4h">4h</option>
      <option value="1d">1d</option>
    </select>
  </label>
  <br><br>

  <table id="crypto-table">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Price (USDT)</th>
        <th>RSI</th>
        <th>EMA9</th>
        <th>EMA20</th>
        <th>EMA50</th>
        <th>EMA100</th>
        <th>MACD</th>
        <th>Signal</th>
        <th>Long</th>
        <th>Short</th>
        <th>Entry Price</th>
        <th>Exit Price</th>
        <th>Support</th>
        <th>Resistance</th>
      </tr>
    </thead>
    <tbody id="crypto-body"></tbody>
  </table>

  <script>
    const symbols = ["BTCUSDT","ETHUSDT"];

    // EMA
    function calcEMA(values, period) {
      let k = 2 / (period + 1);
      let emaArray = [];
      let prevEma = values[0];
      emaArray.push(prevEma);
      for (let i = 1; i < values.length; i++) {
        let ema = values[i] * k + prevEma * (1 - k);
        emaArray.push(ema);
        prevEma = ema;
      }
      return emaArray;
    }

    // RSI
    function calcRSI(values, period=14) {
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        let diff = values[i] - values[i-1];
        if (diff >= 0) gains += diff; else losses -= diff;
      }
      gains /= period;
      losses /= period;
      let rs = losses === 0 ? 100 : gains / losses;
      let rsi = 100 - (100 / (1 + rs));
      return rsi;
    }

    // MACD & Signal
    function calcMACD(values) {
      let ema12 = calcEMA(values, 12);
      let ema26 = calcEMA(values, 26);
      let macdLine = ema12.map((v, i) => v - ema26[i]);
      let signalLine = calcEMA(macdLine.slice(26), 9);
      let lastMACD = macdLine[macdLine.length - 1];
      let lastSignal = signalLine[signalLine.length - 1];
      return { macd: lastMACD, signal: lastSignal };
    }

    async function fetchKlines(symbol, interval="15m") {
      try {
        let url = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(
          "https://api.binance.com/api/v3/klines?symbol=" + symbol + "&interval=" + interval + "&limit=120"
        )}`;
        let res = await fetch(url);
        let klines = await res.json();
        if (!Array.isArray(klines)) throw new Error("Not array");
        return klines;
      } catch (e) {
        console.error("‚ùå Error for", symbol, e);
        return null;
      }
    }

    async function updateTable() {
      let interval = document.getElementById("interval").value;
      let tbody = document.getElementById("crypto-body");
      tbody.innerHTML = "";

      for (let sym of symbols) {
        let row = document.createElement("tr");
        let klines = await fetchKlines(sym, interval);
        if (!klines) {
          row.innerHTML = `<td>${sym}</td><td colspan="13">‚ùå API Error</td>`;
        } else {
          let closes = klines.map(k => parseFloat(k[4]));
          let lastPrice = closes[closes.length-1];

          // EMA
          let ema9 = calcEMA(closes, 9).pop().toFixed(2);
          let ema20 = calcEMA(closes, 20).pop().toFixed(2);
          let ema50 = calcEMA(closes, 50).pop().toFixed(2);
          let ema100 = calcEMA(closes, 100).pop().toFixed(2);

          // RSI
          let rsi = calcRSI(closes.slice(-15), 14).toFixed(2);

          // MACD
          let { macd, signal } = calcMACD(closes);
          macd = macd.toFixed(2);
          signal = signal.toFixed(2);

          // Long/Short signals
          let long = macd > signal ? "‚úÖ" : "";
          let short = macd < signal ? "‚ùå" : "";
          let entry = long ? lastPrice.toFixed(2) : "";
          let exit = short ? lastPrice.toFixed(2) : "";

          // Support/Resistance (ÿ≥ÿßÿØŸá: ⁄©ŸÖÿ™ÿ±€åŸÜ/ÿ®€åÿ¥ÿ™ÿ±€åŸÜ 20 ⁄©ŸÜÿØŸÑ ÿßÿÆ€åÿ±)
          let last20 = closes.slice(-20);
          let support = Math.min(...last20).toFixed(2);
          let resistance = Math.max(...last20).toFixed(2);

          row.innerHTML = `
            <td>${sym}</td>
            <td>${lastPrice}</td>
            <td>${rsi}</td>
            <td>${ema9}</td>
            <td>${ema20}</td>
            <td>${ema50}</td>
            <td>${ema100}</td>
            <td>${macd}</td>
            <td>${signal}</td>
            <td>${long}</td>
            <td>${short}</td>
            <td>${entry}</td>
            <td>${exit}</td>
            <td>${support}</td>
            <td>${resistance}</td>
          `;
        }
        tbody.appendChild(row);
      }
    }

    document.getElementById("interval").addEventListener("change", updateTable);
    updateTable();
  </script>
</body>
</html>

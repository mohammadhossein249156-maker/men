<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 Crypto Dashboard – Top 20</title>
  <style>
    body{font-family:tahoma,Arial,sans-serif;direction:rtl;background:#f5f7fb;margin:0}
    header{background:#1e88e5;color:#fff;padding:14px 10px;text-align:center;position:sticky;top:0;z-index:1000}
    .wrap{max-width:1500px;margin:16px auto;padding:0 12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input,select,button{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px;font-family:inherit}
    button{background:#1e88e5;color:#fff;cursor:pointer}
    button:disabled{background:#90caf9;cursor:not-allowed}
    .note{font-size:12px;color:#546e7a;margin-top:6px}
    .table-wrap{overflow:auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);max-height:75vh}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:center;white-space:nowrap;font-size:13px}
    th{background:#e3f2fd;color:#0d47a1;position:sticky;top:0;z-index:2}
    td:first-child, th:first-child,
    td:nth-child(2), th:nth-child(2),
    td:nth-child(3), th:nth-child(3),
    td:nth-child(4), th:nth-child(4),
    td:nth-child(5), th:nth-child(5) {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 3;
    }
    tr:nth-child(even){background:#f9fbfd}
    tr:hover{background:#f1f8ff}
    .positive{color:#2e7d32;font-weight:600}
    .negative{color:#c62828;font-weight:600}
    .rsi-high{color:#c62828;font-weight:600}
    .rsi-low{color:#2e7d32;font-weight:600}
    .badge{padding:2px 6px;border-radius:8px;font-weight:600}
    .good{background:#e8f5e9;color:#2e7d32}
    .bad{background:#ffebee;color:#c62828}
    .neutral{background:#eceff1;color:#37474f}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <h2>📊 Crypto Dashboard – Top 20</h2>
    <div style="font-size:12px;opacity:.9">منبع داده: Binance (OHLCV) از طریق Codetabs Proxy | اندیکاتورها در مرورگر محاسبه می‌شوند</div>
  </header>

  <div class="wrap">
    <div class="controls">
      <label>تایم‌فریم:</label>
      <select id="interval">
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
      <button id="refreshBtn">بروزرسانی</button>
      <span id="lastUpdate" class="note"></span>
    </div>

    <div class="table-wrap">
      <table id="crypto-table">
        <thead>
          <tr>
            <th title="نماد معاملاتی">Symbol</th>
            <th title="قیمت لحظه‌ای">Price</th>
            <th title="Relative Strength Index (14)">RSI(14)</th>
            <th title="Exponential Moving Average - 9">EMA9</th>
            <th title="Exponential Moving Average - 20">EMA20</th>
            <th title="Exponential Moving Average - 50">EMA50</th>
            <th title="Exponential Moving Average - 100">EMA100</th>
            <th title="Moving Average Convergence Divergence">MACD</th>
            <th title="خط سیگنال MACD">Signal</th>
            <th title="شرط لانگ ساده">L</th>
            <th title="شرط شورت ساده">S</th>
            <th title="Pivot Point روزانه">PP</th>
            <th title="سیگنال لانگ">Long</th>
            <th title="سیگنال شورت">Short</th>
            <th title="محدوده ورود">Entry</th>
            <th title="اهداف و استاپ خروج">Exit (TP/SL)</th>
            <th title="حمایت اخیر">Support</th>
            <th title="مقاومت اخیر">Resistance</th>
            <th title="تثبیت روی حمایت؟">تثبیت روی حمایت؟</th>
            <th title="تثبیت روی مقاومت؟">تثبیت روی مقاومت؟</th>
            <th title="شکست مقاومت">Breakout</th>
            <th title="بازگشت از حمایت">Bounce</th>
            <th title="تقاطع طلایی">Golden Cross</th>
            <th title="رالی صعودی">Rally</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note">
      نکته: این ابزار صرفاً آموزشی است و سیگنال قطعی معامله محسوب نمی‌شود.
    </div>
  </div>

<script>
const SYMBOLS = ["BTCUSDT","ETHUSDT","BNBUSDT","XRPUSDT","SOLUSDT","ADAUSDT","DOGEUSDT","TRXUSDT","MATICUSDT","DOTUSDT","LTCUSDT","AVAXUSDT","LINKUSDT","ATOMUSDT","ETCUSDT","XLMUSDT","FILUSDT","APTUSDT","NEARUSDT","ICPUSDT"];
const PROXY = (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
const fmt = (n, d=2) => (n==null || isNaN(n)) ? "-" : Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
const withinPct = (price, level, pct=0.3) => {if (!price || !level) return false;const diff = Math.abs((price - level)/level)*100;return diff <= pct;};

function ema(values, period){const k = 2/(period+1);const out = [];let prev = values[0];out.push(prev);for(let i=1;i<values.length;i++){const v = values[i]*k + prev*(1-k);out.push(v);prev = v;}return out;}
function rsi(values, period=14){if(values.length < period+1) return [];let gains=0, losses=0;for(let i=1;i<=period;i++){const diff = values[i]-values[i-1];if(diff>=0) gains+=diff; else losses-=diff;}let avgGain=gains/period, avgLoss=losses/period;const out = new Array(period).fill(null);for(let i=period+1;i<values.length;i++){const diff = values[i]-values[i-1];const gain = diff>0?diff:0;const loss = diff<0? -diff:0;avgGain = (avgGain*(period-1)+gain)/period;avgLoss = (avgLoss*(period-1)+loss)/period;const rs = avgLoss===0 ? 1000 : avgGain/avgLoss;out.push( 100 - (100/(1+rs)) );}return out;}
function macd(values, fast=12, slow=26, signalPeriod=9){const ef = ema(values, fast);const es = ema(values, slow);const macdLine = ef.map((v,i)=>(es[i]==null?null:(v-es[i])));const start = slow;const macdValid = macdLine.slice(start).filter(v=>v!=null);const signalPart = ema(macdValid, signalPeriod);const signalLine = new Array(start).fill(null).concat(signalPart);return {macdLine, signalLine};}

async function fetchKlines(symbol, interval="15m", limit=300){const url = PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);const res = await fetch(url);if(!res.ok) throw new Error(`HTTP ${res.status}`);const data = await res.json();if(!Array.isArray(data)) throw new Error("Bad payload");return data;}
async function fetchDailyPivot(symbol){const url = PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=3`);const res = await fetch(url);if(!res.ok) return null;const data = await res.json();if(!Array.isArray(data) || data.length < 2) return null;const prev = data[data.length-2];const H = +prev[2], L = +prev[3], C = +prev[4];return (H+L+C)/3;}

async function buildTable(){
  const tbody = document.querySelector("#crypto-table tbody");
  tbody.innerHTML = "";
  const interval = document.getElementById("interval").value;
  for(const symbol of SYMBOLS){
    try{
      const [kl, pp] = await Promise.all([fetchKlines(symbol, interval, 300), fetchDailyPivot(symbol)]);
      const closes = kl.map(k=>+k[4]);
      const highs  = kl.map(k=>+k[2]);
      const lows   = kl.map(k=>+k[3]);
      const last   = closes.at(-1);

      const ema9Arr=ema(closes,9), ema20Arr=ema(closes,20), ema50Arr=ema(closes,50), ema100Arr=ema(closes,100), ema200Arr=ema(closes,200);
      const rsiArr=rsi(closes,14); const {macdLine, signalLine}=macd(closes,12,26,9);
      const ema9v=ema9Arr.at(-1), ema20v=ema20Arr.at(-1), ema50v=ema50Arr.at(-1), ema100v=ema100Arr.at(-1), ema200v=ema200Arr.at(-1);
      const rsiv=rsiArr.at(-1), macdv=macdLine.at(-1), sigv=signalLine.at(-1);

      const longCond= last>ema20v && macdv>sigv && rsiv>50;
      const shortCond= last<ema20v && macdv<sigv && rsiv<50;

      const macdClass=(macdv-sigv)>=0?"positive":"negative";
      const rsiClass= rsiv>=70?"rsi-high": rsiv<=30?"rsi-low":"";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="nowrap">${symbol}</td>
        <td>${fmt(last,4)}</td>
        <td class="${rsiClass}">${fmt(rsiv,2)}</td>
        <td>${fmt(ema9v,4)}</td>
        <td>${fmt(ema20v,4)}</td>
        <td>${fmt(ema50v,4)}</td>
        <td>${fmt(ema100v,4)}</td>
        <td class="${macdClass}">${fmt(macdv,6)}</td>
        <td class="${macdClass}">${fmt(sigv,6)}</td>
        <td>${longCond?"L":""}</td>
        <td>${shortCond?"S":""}</td>
        <td>${pp?fmt(pp,2):"-"}</td>
        <td>${longCond?'<span class="badge good">✅</span>':'<span class="badge neutral">—</span>'}</td>
        <td>${shortCond?'<span class="badge bad">⚠</span>':'<span class="badge neutral">—</span>'}</td>
        <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
      `;
      tbody.appendChild(tr);
    }catch(err){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="24" class="negative">خطا برای ${symbol}: ${err.message}</td>`;
      tbody.appendChild(tr);
    }
  }
  document.getElementById("lastUpdate").textContent="آخرین بروزرسانی: "+new Date().toLocaleString();
}

document.getElementById("refreshBtn").addEventListener("click", buildTable);
buildTable();
setInterval(buildTable, 60000);
</script>
</body>
</html>

